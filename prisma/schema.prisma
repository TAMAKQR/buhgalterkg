generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id          String            @id @default(cuid())
  telegramId  String            @unique
  displayName String
  username    String?
  role        UserRole          @default(MANAGER)
  avatarUrl   String?
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  ledger      CashEntry[]
  assignments HotelAssignment[]
  shifts      Shift[]           @relation("ShiftManager")
  receivedHandovers Shift[]     @relation("ShiftHandoverRecipient")
  productSales ProductSale[]
  inventoryEntries ProductInventoryEntry[]
}

model Hotel {
  id              String            @id @default(cuid())
  name            String
  address         String
  city            String?
  managerSharePct Int?              @map("manager_share_pct")
  cleaningChatId  String?           @map("cleaning_chat_id")
  notes           String?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  ledger          CashEntry[]
  assignments     HotelAssignment[]
  rooms           Room[]
  stays           RoomStay[]
  shifts          Shift[]
  productCategories ProductCategory[]
  products        Product[]
  productSales    ProductSale[]
}

model HotelAssignment {
  id        String   @id @default(cuid())
  hotelId   String
  userId    String
  role      UserRole
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  pinCode   String?  @map("pin_code") @db.VarChar(6)
  shiftPayAmount Int? @map("shift_pay_amount")
  revenueSharePct Int? @map("revenue_share_pct")
  hotel     Hotel    @relation(fields: [hotelId], references: [id])
  user      User     @relation(fields: [userId], references: [id])

  @@unique([hotelId, userId])
  @@index([hotelId, pinCode])
}

model Room {
  id            String     @id @default(cuid())
  hotelId       String
  label         String
  floor         String?
  isActive      Boolean    @default(true)
  status        RoomStatus @default(AVAILABLE)
  currentStayId String?    @unique
  notes         String?
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  currentStay   RoomStay?  @relation("RoomCurrentStay", fields: [currentStayId], references: [id])
  hotel         Hotel      @relation(fields: [hotelId], references: [id])
  stays         RoomStay[] @relation("RoomStayHistory")

  @@index([hotelId, label])
}

model RoomStay {
  id                String         @id @default(cuid())
  roomId            String
  hotelId           String
  shiftId           String?
  guestName         String?
  scheduledCheckIn  DateTime
  scheduledCheckOut DateTime
  actualCheckIn     DateTime?
  actualCheckOut    DateTime?
  status            StayStatus     @default(SCHEDULED)
  notes             String?
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  amountPaid        Int?
  paymentMethod     PaymentMethod?
  cashPaid          Int            @default(0)
  cardPaid          Int            @default(0)
  currentRoom       Room?          @relation("RoomCurrentStay")
  hotel             Hotel          @relation(fields: [hotelId], references: [id])
  room              Room           @relation("RoomStayHistory", fields: [roomId], references: [id])
  shift             Shift?         @relation(fields: [shiftId], references: [id])
  productSales      ProductSale[]
}

model Shift {
  id           String      @id @default(cuid())
  hotelId      String
  managerId    String
  status       ShiftStatus @default(OPEN)
  openedAt     DateTime    @default(now())
  closedAt     DateTime?
  openingCash  Int
  closingCash  Int?
  handoverCash Int?
  openingNote  String?
  closingNote  String?
  handoverNote String?
  handoverRecipientId String?
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  number       Int         @default(0)
  ledger       CashEntry[]
  stays        RoomStay[]
  hotel        Hotel       @relation(fields: [hotelId], references: [id])
  manager      User        @relation("ShiftManager", fields: [managerId], references: [id])
  handoverRecipient   User?      @relation("ShiftHandoverRecipient", fields: [handoverRecipientId], references: [id])
  productSales ProductSale[]
  inventoryEntries ProductInventoryEntry[]

  @@unique([hotelId, number])
  @@index([hotelId, status])
}

model CashEntry {
  id         String          @id @default(cuid())
  shiftId    String?
  hotelId    String
  managerId  String?
  entryType  LedgerEntryType
  method     PaymentMethod
  amount     Int
  note       String?
  meta       Json?
  recordedAt DateTime        @default(now())
  hotel      Hotel           @relation(fields: [hotelId], references: [id])
  manager    User?           @relation(fields: [managerId], references: [id])
  shift      Shift?          @relation(fields: [shiftId], references: [id])
}

model ProductCategory {
  id          String   @id @default(cuid())
  hotelId     String
  name        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  hotel       Hotel    @relation(fields: [hotelId], references: [id])
  products    Product[]

  @@unique([hotelId, name])
}

model Product {
  id               String   @id @default(cuid())
  hotelId          String
  categoryId       String?
  name             String
  sku              String?
  description      String?
  costPrice        Int
  sellPrice        Int
  unit             String?
  stockOnHand      Int      @default(0)
  reorderThreshold Int?
  isActive         Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  hotel            Hotel    @relation(fields: [hotelId], references: [id])
  category         ProductCategory? @relation(fields: [categoryId], references: [id])
  inventoryEntries ProductInventoryEntry[]
  sales            ProductSale[]

  @@unique([hotelId, name])
  @@index([categoryId])
}

model ProductInventoryEntry {
  id             String                           @id @default(cuid())
  productId      String
  shiftId        String?
  userId         String?
  adjustmentType ProductInventoryAdjustmentType
  quantity       Int
  costTotal      Int?
  note           String?
  createdAt      DateTime                         @default(now())
  product        Product                          @relation(fields: [productId], references: [id])
  shift          Shift?                           @relation(fields: [shiftId], references: [id])
  user           User?                            @relation(fields: [userId], references: [id])

  @@index([productId])
  @@index([shiftId])
}

model ProductSale {
  id            String           @id @default(cuid())
  productId     String
  hotelId       String
  shiftId       String?
  roomStayId    String?
  soldById      String?
  saleType      ProductSaleType
  quantity      Int
  unitPrice     Int
  totalAmount   Int
  paymentMethod PaymentMethod
  note          String?
  createdAt     DateTime         @default(now())
  product       Product          @relation(fields: [productId], references: [id])
  hotel         Hotel            @relation(fields: [hotelId], references: [id])
  shift         Shift?           @relation(fields: [shiftId], references: [id])
  roomStay      RoomStay?        @relation(fields: [roomStayId], references: [id])
  soldBy        User?            @relation(fields: [soldById], references: [id])

  @@index([hotelId])
  @@index([shiftId])
  @@index([roomStayId])
}

enum UserRole {
  ADMIN
  MANAGER
}

enum ShiftStatus {
  OPEN
  CLOSED
}

enum PaymentMethod {
  CASH
  CARD
}

enum LedgerEntryType {
  CASH_IN
  CASH_OUT
  MANAGER_PAYOUT
  ADJUSTMENT
}

enum StayStatus {
  SCHEDULED
  CHECKED_IN
  CHECKED_OUT
  CANCELLED
}

enum RoomStatus {
  AVAILABLE
  OCCUPIED
  DIRTY
  HOLD
}

enum ProductSaleType {
  ROOM
  TAKEAWAY
  DIRECT
}

enum ProductInventoryAdjustmentType {
  RESTOCK
  ADJUSTMENT
  WRITE_OFF
}
