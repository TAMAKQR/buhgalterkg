generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id          String            @id @default(cuid())
  telegramId  String            @unique
  displayName String
  username    String?
  role        UserRole          @default(MANAGER)
  avatarUrl   String?
  loginName   String?           @unique @map("login_name")
  loginHash   String?           @map("login_hash")
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  ledger      CashEntry[]
  assignments HotelAssignment[]
  shifts      Shift[]           @relation("ShiftManager")
  receivedHandovers Shift[]     @relation("ShiftHandoverRecipient")
}

model Hotel {
  id              String            @id @default(cuid())
  name            String
  address         String
  city            String?
  timezone        String            @default("Asia/Bishkek")
  currency        String            @default("KGS")
  managerSharePct Int?              @map("manager_share_pct")
  cleaningChatId  String?           @map("cleaning_chat_id")
  notes           String?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  ledger          CashEntry[]
  assignments     HotelAssignment[]
  rooms           Room[]
  stays           RoomStay[]
  shifts          Shift[]
  bonusTiers      BonusTier[]
}

model HotelAssignment {
  id        String   @id @default(cuid())
  hotelId   String
  userId    String
  role      UserRole
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  pinCode   String?  @map("pin_code") @db.VarChar(6)
  shiftPayAmount Int? @map("shift_pay_amount")
  revenueSharePct Int? @map("revenue_share_pct")
  hotel     Hotel    @relation(fields: [hotelId], references: [id])
  user      User     @relation(fields: [userId], references: [id])

  @@unique([hotelId, userId])
  @@index([hotelId, pinCode])
}

model Room {
  id            String     @id @default(cuid())
  hotelId       String
  label         String
  floor         String?
  isActive      Boolean    @default(true)
  status        RoomStatus @default(AVAILABLE)
  currentStayId String?    @unique
  notes         String?
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  currentStay   RoomStay?  @relation("RoomCurrentStay", fields: [currentStayId], references: [id])
  hotel         Hotel      @relation(fields: [hotelId], references: [id])
  stays         RoomStay[] @relation("RoomStayHistory")

  @@index([hotelId, label])
}

model RoomStay {
  id                String         @id @default(cuid())
  roomId            String
  hotelId           String
  shiftId           String?
  guestName         String?
  scheduledCheckIn  DateTime
  scheduledCheckOut DateTime
  actualCheckIn     DateTime?
  actualCheckOut    DateTime?
  status            StayStatus     @default(SCHEDULED)
  notes             String?
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  amountPaid        Int?
  paymentMethod     PaymentMethod?
  cashPaid          Int            @default(0)
  cardPaid          Int            @default(0)
  currentRoom       Room?          @relation("RoomCurrentStay")
  hotel             Hotel          @relation(fields: [hotelId], references: [id])
  room              Room           @relation("RoomStayHistory", fields: [roomId], references: [id])
  shift             Shift?         @relation(fields: [shiftId], references: [id])
}

model Shift {
  id           String      @id @default(cuid())
  hotelId      String
  managerId    String
  status       ShiftStatus @default(OPEN)
  openedAt     DateTime    @default(now())
  closedAt     DateTime?
  openingCash  Int
  closingCash  Int?
  handoverCash Int?
  openingNote  String?
  closingNote  String?
  handoverNote String?
  handoverRecipientId String?
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  number       Int         @default(0)
  ledger       CashEntry[]
  stays        RoomStay[]
  hotel        Hotel       @relation(fields: [hotelId], references: [id])
  manager      User        @relation("ShiftManager", fields: [managerId], references: [id])
  handoverRecipient   User?      @relation("ShiftHandoverRecipient", fields: [handoverRecipientId], references: [id])

  @@unique([hotelId, number])
  @@index([hotelId, status])
}

model CashEntry {
  id         String          @id @default(cuid())
  shiftId    String?
  hotelId    String
  managerId  String?
  entryType  LedgerEntryType
  method     PaymentMethod
  amount     Int
  note       String?
  meta       Json?
  recordedAt DateTime        @default(now())
  hotel      Hotel           @relation(fields: [hotelId], references: [id])
  manager    User?           @relation(fields: [managerId], references: [id])
  shift      Shift?          @relation(fields: [shiftId], references: [id])
}


enum UserRole {
  ADMIN
  MANAGER
  OBSERVER
}

enum ShiftStatus {
  OPEN
  CLOSED
}

enum PaymentMethod {
  CASH
  CARD
}

enum LedgerEntryType {
  CASH_IN
  CASH_OUT
  MANAGER_PAYOUT
  ADJUSTMENT
}

enum StayStatus {
  SCHEDULED
  CHECKED_IN
  CHECKED_OUT
  CANCELLED
}

enum RoomStatus {
  AVAILABLE
  OCCUPIED
  DIRTY
  HOLD
}

model BonusTier {
  id        String   @id @default(cuid())
  hotelId   String
  threshold Int      // cash threshold in smallest unit (tiyin/tenge)
  bonus     Int      // fixed bonus amount in smallest unit
  bonusPct  Int?     @map("bonus_pct") // alternative: percentage * 100 (e.g. 500 = 5%)
  hotel     Hotel    @relation(fields: [hotelId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([hotelId, threshold])
  @@index([hotelId])
}

